DELIMITER $$

CREATE PROCEDURE AddServerAndCreatePackageTable(
    IN p_hostname VARCHAR(255),
    IN p_ip_address VARCHAR(45),
    IN p_os_type VARCHAR(50),
    IN p_auth_code VARCHAR(10),
    IN p_status ENUM('active', 'inactive'),
    IN p_last_patch_date DATETIME
)
BEGIN
    -- Insert the new server
    INSERT INTO servers (
        hostname, ip_address, os_type, Auth_code, status, last_patch_date
    ) VALUES (
        p_hostname, p_ip_address, p_os_type, p_auth_code, p_status, p_last_patch_date
    );

    -- Create the server-specific package table using the hostname
    SET @sql = CONCAT(
        'CREATE TABLE IF NOT EXISTS `', REPLACE(p_hostname, '`', ''), '` (',
        'package_name VARCHAR(255) NOT NULL, ',
        'current_version VARCHAR(100) NOT NULL, ',
        'updating_version VARCHAR(100), ',
        'PRIMARY KEY (package_name)',
        ') ENGINE=InnoDB;'
    );

    PREPARE stmt FROM @sql;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
END$$

DELIMITER ;
